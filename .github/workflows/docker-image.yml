# 这是一个 GitHub Actions 工作流，用于自动构建和发布 Docker 镜像。

name: 构建并推送 Docker 镜像

# 此工作流会在以下情况被触发：
# 1. 当有代码推送到 main 分支时。
# 2. 当有新的版本标签 (如 v1.0.0) 被推送时。
# 3. 也可以在 Actions 标签页手动触发。
on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-and-push:
    # 使用最新版的 Ubuntu 环境来运行此任务
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 步骤 1: 检出你的仓库代码
      - name: 检出仓库代码
        uses: actions/checkout@v4

      # 步骤 2: 设置 QEMU (用于支持多平台构建，可选但推荐)
      - name: 设置 QEMU
        uses: docker/setup-qemu-action@v3

      # 步骤 3: 设置 Docker Buildx (一个更高级的构建工具，支持缓存等功能)
      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤 4: 登录到 Docker Hub (使用你之前创建的 Secrets)
      - name: 登录到 Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 步骤 5: 提取 Docker 镜像的元数据 (例如标签和 Label)
      # 这个 action 会自动生成一些智能标签。例如：
      # - 推送到 main 分支 -> 会生成 'latest' 标签。
      # - 推送标签 v1.2.3 -> 会生成 'v1.2.3', 'v1.2', 'v1' 等标签。
      - name: 提取 Docker 元数据
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: aitnr/aistudioproxyapi # 你的镜像名称

      # 步骤 6: 构建镜像并推送到 Docker Hub
      - name: 构建并推送 Docker 镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          # 启用推送，构建成功后镜像会被发布
          file: ./docker/Dockerfile  
          push: true
          # 使用元数据 action 生成的标签
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # 启用构建缓存，以加速未来的构建
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # 从 secrets 传入 PROXY_ADDR 构建参数。
          # 如果 PROXY_ADDR 这个 secret 没有设置，这个参数值会是空的，
          # 你的 Dockerfile 中的 'if' 条件会正确处理这种情况。
          build-args: |
            PROXY_ADDR=${{ secrets.PROXY_ADDR }}
